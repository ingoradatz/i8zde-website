<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <meta name="og:site_name" content="I8z.de"/>
    <link rel="canonical" href="https://test.i8z.de/news/2018-06-24/url-shortening-with-couchdb/index"/>
    <meta name="twitter:url" content="https://test.i8z.de/news/2018-06-24/url-shortening-with-couchdb/index"/>
    <meta name="og:url" content="https://test.i8z.de/news/2018-06-24/url-shortening-with-couchdb/index"/>
    <title>URL Shortening with CouchDB | I8z.de</title>
    <meta name="twitter:title" content="URL Shortening with CouchDB | I8z.de"/>
    <meta name="og:title" content="URL Shortening with CouchDB | I8z.de"/>
    <meta name="description" content="Personal content of Ingo Radatz"/>
    <meta name="twitter:description" content="Personal content of Ingo Radatz"/>
    <meta name="og:description" content="Personal content of Ingo Radatz"/>
    <meta name="twitter:card" content="summary"/>
    <link rel="stylesheet" href="/styles.css" type="text/css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="shortcut icon" href="/images/favicon.png" type="image/png"/>
    <link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to I8z.de"/>
    <meta name="twitter:image" content="https://test.i8z.de/img/"/>
    <meta name="og:image" content="https://test.i8z.de/img/"/>
  </head>
  <body>
    <header>
      <a href="/" id="site-brand">
        <svg id="site-logo" version="1.1" viewBox="0 0 41.22 47" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><path d="M0 3.12993C-8.42869e-08 5.05818 1.22961 6.25985 3.24171 6.25985L37.9783 6.25985C39.9904 6.25985 41.22 5.05818 41.22 3.12993C41.22 1.17372 39.9904 1.60634e-06 37.9783 1.51838e-06L3.24171 0C1.22961-8.79515e-08 8.55083e-08 1.17372 0 3.12993ZM0.447131 27.9178C0.447131 39.9345 7.93659 47.0048 20.6799 47.0048C33.3952 47.0048 40.7729 39.9066 40.7729 27.9178L40.7729 16.8234C40.7729 14.8671 39.5433 13.6934 37.5312 13.6934L3.68884 13.6934C1.67675 13.6934 0.447132 14.8671 0.447132 16.8233L0.447131 27.9178ZM5.86861 27.331L5.86861 19.9533L35.3793 19.9533L35.3793 27.331C35.3793 35.8544 30.1255 40.6052 20.624 40.6052C11.0945 40.6052 5.86861 35.8824 5.86861 27.331Z" fill="currentColor" fill-rule="evenodd" opacity="1" stroke="none" /></g></svg></a>
      <nav>
        <ul>
          <li>
            <a href="/receipes">Receipes</a></li>
          <li>
            <a href="/bookmarks">Bookmarks</a></li>
          <li>
            <span>&nbsp;</span></li>
          <li>
            <a href="/about">About</a></li>
          <li>
            <a href="/privacy">Privacy</a></li></ul></nav></header>
    <div class="wrapper"><h2>chronik of the idea</h2><p>As user of the third-party twitter app <a href="http://tapbots.com/software/tweetbot/">Tweetbot</a> some day i discovered the customization for the URL shortening.</p><img src="tweetbot.png" alt="tweetbot screenshots"/><p>After hacking a little prototype CouchApp i had to face a problem has gone down with all the enthusiasm: Tweetbot requests my URL shortener via GET request and the CouchDB always answers with <code>method_not_allowed</code>.</p><p>A hotfix was to setup a simple <a href="http://expressjs.com/guide.html">nodejs express route</a> which has proxified the GET calls to POSTs. But that couldn't be more then a hotfix - so maybe a review of the CouchDB source code could give some answers.<br><br><a href="https://github.com/jchris">JChris</a> commited <a href="https://github.com/apache/couchdb/blame/master/share/server/render.js#L272">at the end of 2009</a> the following code into CouchDB's <code>share/server/render.js</code>:</p><pre><code class="language-js">// for analytics logging applications 
// you might want to remove the next line
if (method == "GET")
  throw([
    "error",
    "method_not_allowed",
    "Update functions do not allow GET"
  ]);
</code></pre><p>So, without the <a href="https://github.com/apache/couchdb/blame/master/share/server/render.js#L272">line 273</a> in the <code>render.js</code> the GET requests can trigger document updates - for sure, the only ways to send data within are the query and header key/value's.</p><p>Hint: A quick and dirty test is possible by commenting out the line in an already installed CouchDB - the render.js is one of several ressources which are merged together into the <code>share/couchdb/server/main.js</code> during the build process. But be aware that this file shouldn't be edited manually in common as can be read in the first line <code>// DO NOT EDIT THIS FILE BY HAND</code>.</p><h2>URL shortening</h2><img src="rewrite_update.png" alt="shorturl flow"/><p>To be clear, the following approach enables redirects via 302 HTTP status code - useful for <strong>redirects to ressouces outside the CouchDB</strong>. The client (e.g. browser) has to follow the redirect by itself in an additional second request.</p><p>The CouchDB rewriting capability - vhost+rewrite-handler - are used to form the API only (redirecting to service execution logic).</p><p>The URL shortening has two major services:</p><ol><li>create a short URL (~20 characters) that points to the longer URL</li><li>redirect/forward every request of the short URL to the longer URL</li></ol><p>Tweetbot's <a href="http://tapbots.net/tweetbot/custom_url/">documentation</a> describes:</p><pre><code class="language-js">Custom URL Shortener
The request will be replace the %@ string with the URL that needs to be shortened.

The response should be one of the following formats:
URL
{ status_code : 200, data : { url : URL } }
{ shortURL : URL }
{ shorturl : URL }

Examples:
domain.tld/api/v1/cligs/create?url=%@
domain.tld/api?u=%@&amp;i=0
domain.tld/api.php?u=%@
</code></pre><p>Let's create short URLs with a CouchDB update handler. The API endpoint should be <code>/url</code> for now but can be changed or removed in a custom installation. Example given when the shortening service has an own (sub-)domain. The resulting endpoint paths are:</p><ul><li><strong>read/delete url:</strong> GET,DELETE <code>/url/:id</code></li><li><strong>edit url:</strong> POST,PUT <code>/url/:id?url=%</code></li><li><strong>create titled url:</strong> GET,POST,PUT <code>/url/create?url=%&amp;title=%</code> (/url/title)</li><li><strong>create hashed url:</strong>GET,POST,PUT <code>/url/create?url=%</code> (/url/nFgH)</li></ul><img src="update_handler_flow.svg" alt="shorturl uml"/><p>Rules in the <code>rewrites.json</code></p><pre><code class="language-js">{
  "from": "url/create",
  "to": "_update/shorturl", 
  "method": "*",
  "query": {
    "path": "create"
   }
},{
  "from": "url/:pid",
  "to": "_update/shorturl/:pid",
  "method": "*"
}
</code></pre><p>A <code>short URL document schema</code>:</p><pre><code class="language-json">{
  "_id": "test-url",
  "edited_at": "2014-02-02T16:55:26.158Z",
  "url": "http://domain.tld/path/to",
  "created_at": "2014-02-02T16:55:26.158Z",
  "type": "shorturl"
}
</code></pre><p>The <code>updates/shorturl.js</code> handles all requests. When the doc gets written (CREATE, EDIT, DELETE) the handler is responsive for transfering the values of query params (e.g. title, url) into the JSON schema only. Whether the values and changes are schema-conform will validate and permit the <code>validate_doc_update.js</code> later during every document update.</p><p>The query param <code>title</code> is optional with a fallback to hashes. A title/hash can not be changed later (it's the docid). Creating an existing shorturl will end in a 409 conflict. Thats not case for titled urls only - also ultra-short hashed urls can conflict.</p><p>The <code>validate_doc_update.js</code> ensures:</p><ul><li><code>doc._id</code> contains URL safe chars only</li><li><code>doc.type</code> is valued "shorturl"</li><li><code>doc.created_at</code> is a date, once set never changes and not in the future</li><li><code>doc.edited_at</code> is a date younger then created_at, refreshs with every doc update</li><li><code>doc.url</code> is a url and must change with doc updates</li></ul><p><strong>That's it.</strong></p><h2>Demo</h2><p>I have an installation running under the domain <code>http://url.i8z.de</code> with 4-chars hashs (22 characters total).</p><p>The configuration in Tweetbot points to <code>http://url.i8z.de?create?url=%@</code> and works as expected. I decided to not shorten to a minimum (e.g. <code>http://u.i8z.de/xC</code> (18 characters)) because <a href="https://dev.twitter.com/discussions/1062">Twitter shortens every url to a fix length</a> - it will end in a shortened URL which gets extended back in a second step, crazy.</p><ul><li><strong>create titled url:</strong> <a href="http://url.i8z.de/create?url=yahoo.com&title=yahoo">url.i8z.de/create?url=yahoo.com&amp;title=yahoo</a></li><li><strong>create hashed url:</strong> <a href="http://url.i8z.de/create?url=google.com">url.i8z.de/create?url=google.com</a></li><li><strong>read url:</strong> <a href="http://url.i8z.de/yahoo">url.i8z.de/yahoo</a></li><li><strong>edit url:</strong> POST,PUT <code>url.i8z.de/yahoo?url=yahoo.de</code></li><li><strong>delete url:</strong> DELETE <code>url.i8z.de/yahoo</code></li></ul><p>how to use</p><ul><li>bookmarkable titled urls as proxy, e.g. /latest or /current</li><li>hashed urls are for everything else</li></ul><p>The full code are reviewable on <a href="https://github.com/llabball/couchdb-urlshortener">github</a>.</p></div>
    <footer>
      <p>Footer</p></footer></body>
</html>